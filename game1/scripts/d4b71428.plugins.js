(function(a,b){function h(a,b){return a===null?b==="null":a===undefined?b==="undefined":a.is&&a instanceof d?b==="element":Object.prototype.toString.call(a).toLowerCase().indexOf(b)>7}function l(a){var b,c,d,e,f,g,k,m,n;if(a instanceof l)return a;h(a,"array")||(a=String(a).replace(/\s/g,"").toLowerCase().match(/(?:\+,|[^,])+/g));for(b=0,c=a.length;b<c;++b){h(a[b],"array")||(a[b]=String(a[b]).match(/(?:\+\/|[^\/])+/g)),g=[],d=a[b].length;while(d--){var k=a[b][d];f={jwertyCombo:String(k),shiftKey:!1,ctrlKey:!1,altKey:!1,metaKey:!1},h(k,"array")||(k=String(k).toLowerCase().match(/(?:(?:[^\+])+|\+\+|^\+$)/g)),e=k.length;while(e--)k[e]==="++"&&(k[e]="+"),k[e]in j.mods?f[i[j.mods[k[e]]]]=!0:k[e]in j.keys?f.keyCode=j.keys[k[e]]:m=k[e].match(/^\[([^-]+\-?[^-]*)-([^-]+\-?[^-]*)\]$/);if(h(f.keyCode,"undefined"))if(m&&m[1]in j.keys&&m[2]in j.keys){m[2]=j.keys[m[2]],m[1]=j.keys[m[1]];for(n=m[1];n<m[2];++n)g.push({altKey:f.altKey,shiftKey:f.shiftKey,metaKey:f.metaKey,ctrlKey:f.ctrlKey,keyCode:n,jwertyCombo:String(k)});f.keyCode=n}else f.keyCode=0;g.push(f)}this[b]=g}return this.length=b,this}var c=a.document,d=a.jQuery||a.Zepto||a.ender||c,e,f,g="keydown";d===c?(e=function(a,b){return a?d.querySelector(a,b||d):d},f=function(a,b){a.addEventListener(g,b,!1)},$f=function(a,b){var c=document.createEvent("Event"),e;c.initEvent(g,!0,!0);for(e in b)c[e]=b[e];return(a||d).dispatchEvent(c)}):(e=function(a,b,e){return d(a||c,b)},f=function(a,b){d(a).bind(g+".jwerty",b)},$f=function(a,b){d(a||c).trigger(d.Event(g,b))});var i={16:"shiftKey",17:"ctrlKey",18:"altKey",91:"metaKey"},j={mods:{"⇧":16,shift:16,"⌃":17,ctrl:17,"⌥":18,alt:18,option:18,"⌘":91,meta:91,cmd:91,"super":91,win:91},keys:{"⌫":8,backspace:8,"⇥":9,"⇆":9,tab:9,"↩":13,"return":13,enter:13,"⌅":13,pause:19,"pause-break":19,"⇪":20,caps:20,"caps-lock":20,"⎋":27,escape:27,esc:27,space:32,"↖":33,pgup:33,"page-up":33,"↘":34,pgdown:34,"page-down":34,"⇟":35,end:35,"⇞":36,home:36,ins:45,insert:45,del:46,"delete":46,"←":37,left:37,"arrow-left":37,"↑":38,up:38,"arrow-up":38,"→":39,right:39,"arrow-right":39,"↓":40,down:40,"arrow-down":40,"*":106,star:106,asterisk:106,multiply:106,"+":107,plus:107,"-":109,subtract:109,";":186,semicolon:186,"=":187,equals:187,",":188,comma:188,".":190,period:190,"full-stop":190,"/":191,slash:191,"forward-slash":191,"`":192,tick:192,"back-quote":192,"[":219,"open-bracket":219,"\\":220,"back-slash":220,"]":221,"close-bracket":221,"'":222,quote:222,apostraphe:222}};k=95,n=0;while(++k<106)j.keys["num-"+n]=k,++n;k=47,n=0;while(++k<58)j.keys[n]=k,++n;k=111,n=1;while(++k<136)j.keys["f"+n]=k,++n;var k=64;while(++k<91)j.keys[String.fromCharCode(k).toLowerCase()]=k;var m=b.jwerty={event:function(a,b,c){if(h(b,"boolean")){var d=b;b=function(){return d}}a=new l(a);var e=0,f=a.length-1,g,i;return function(d){if(i=m.is(a,d,e)){if(e<f){++e;return}g=b.call(c||this,d,i),g===!1&&d.preventDefault(),e=0;return}e=m.is(a,d)?1:0}},is:function(a,b,c){a=new l(a),c=c||0,a=a[c],b=b.originalEvent||b;var d,e=a.length,f=!1;while(e--){f=a[e].jwertyCombo;for(var g in a[e])g!=="jwertyCombo"&&b[g]!=a[e][g]&&(f=!1);if(f!==!1)return f}return f},key:function(b,c,d,g,i){var j=h(d,"element")||h(d,"string")?d:g,k=j===d?a:d,l=j===d?g:i;f(h(j,"element")?j:e(j,l),m.event(b,c,k))},fire:function(a,b,c,d){a=new l(a);var f=h(c,"number")?c:d;$f(h(b,"element")?b:e(b,c),a[f||0][0])},KEYS:j}})(this,typeof module!="undefined"&&module.exports?module.exports:this);var Helper={rand:function(a,b){var c=Math.random()*(b-a)+a;return Math.round(c)},check_collision:function(a,b){var c,d,e;return c=a.x<=b.player_x+b.player_width&&a.x+a.width>=b.player_x?!0:!1,d=a.y<=b.player_y+b.player_height&&a.y+a.height>=b.player_y?!0:!1,e=c&&d?!0:!1,e},check_pixel_collision:function(a,b,c,d,e){var f=a.getImageData(b-1,c-1,d+2,e+2),g=f.data,h=g.length;for(var i=0;i<g.length;i+=4){var j=g[i],k=g[i+1],l=g[i+2],m=g[i+3];if(j===30&&k===100&&l===30||j===20&&k===90&&l===220||j===0&&k===0&&l===0)return"wall";if(j===155&&k===84&&l===32)return"house"}return!1},drawRectangle:function(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c,d,e,f)},drawCircle:function(a,b,c,d,e,f,g){a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.fillStyle=e,a.fill(),a.lineWidth=f,a.strokeStyle=g,a.stroke()},isIn:function(a,b){return a.indexOf(b)!==-1?!0:!1},notIn:function(a,b){return a.indexOf(b)===-1?!0:!1}},houses=[{x:30,y:483,width:20,height:10,number:Helper.rand(1,10),questions_correct:0,greeting:"Hello, please come in.",goodbye:"Good luck on your journey!"},{x:34,y:135,width:30,height:10,number:Helper.rand(1,10),questions_correct:0,greeting:"Hello, please come in.",goodbye:"Good luck on your journey!"},{x:579,y:98,width:30,height:10,number:Helper.rand(1,10),questions_correct:0,greeting:"Hello, please come in.",goodbye:"Good luck on your journey!"},{x:762,y:76,width:30,height:10,number:Helper.rand(1,10),questions_correct:0,greeting:"Hello, please come in.",goodbye:"Good luck on your journey!"},{x:340,y:501,width:10,height:40,number:Helper.rand(1,10),questions_correct:0,greeting:"Hello, please come in.",goodbye:"Good luck on your journey!"}],Question=function(a,b,c){this.level=b,this.mode=a.mode,this.answer=0,this.question_string="",this.create(c)};Question.prototype.create=function(a){if(this.level===1){var b=this,c=typeof a=="undefined"?Helper.rand(2,11):a,d=Helper.rand(2,11);switch(this.mode){case"+":this.answer=c+d,this.question_string=" "+c+" "+this.mode+" "+d;break;case"*":this.answer=c*d,this.question_string=" "+c+" x  "+d;break;case"-":this.answer=c-d,this.question_string=" "+c+" "+this.mode+" "+d;break;case"/":this.answer=c/d,this.question_string=" "+c+" "+this.mode+" "+d}}};var Car=function(a,b){this.game=a,this.road=b,this.context=a.context,this.canvas_width=a.context_width,this.canvas_height=a.context_height,this.level=a.user.level,this.x=0,this.y=0,this.width=65,this.height=35,this.vin=Helper.rand(1,1e12),this.image=document.getElementById("vehicles_image");switch(this.road){case"vert_left_south":this.x=163,this.y=0,this.sprite_x=349,this.sprite_y=144,this.width=32,this.height=68;break;case"vert_left_north":this.x=117,this.y=600,this.sprite_x=281,this.sprite_y=217,this.width=32,this.height=69;break;case"vert_right":this.x=670,this.y=0,this.sprite_x=234,this.sprite_y=143,this.width=30,this.height=48;break;case"horz_slow":this.x=0,this.y=350,this.sprite_x=495,this.sprite_y=31,this.width=50,this.height=32;break;case"horz_medium":this.x=0,this.y=273,this.sprite_x=65,this.sprite_y=72,this.width=106,this.height=53;break;case"horz_fast":this.x=0,this.y=215,this.sprite_x=104,this.sprite_y=27,this.width=63,this.height=34}};Car.prototype.update=function(){switch(this.road){case"vert_left_south":this.y=this.y-this.height>this.canvas_height?0:this.y+4;break;case"vert_left_north":this.y=this.y+this.height<0?this.canvas_height:this.y-4;break;case"vert_right":this.y=this.y-this.height>this.canvas_height*1.2?0:this.y+4;break;case"horz_slow":this.x=this.x-this.width>this.canvas_width?0:this.x+2;break;case"horz_medium":this.x=this.x-this.width>this.canvas_width?0:this.x+4;break;case"horz_fast":this.x=this.x-this.width>this.canvas_width*3?0:this.x+10}},Car.prototype.draw=function(){Helper.drawRectangle(this.context,"red",this.x,this.y,this.width,this.height),this.context.drawImage(this.image,this.sprite_x,this.sprite_y,this.width,this.height,this.x,this.y,this.width,this.height)},Car.prototype.moveAhead=function(){switch(this.road){case"vert_left_south":this.y=this.y+this.height*2;break;case"vert_left_north":this.y=this.y-this.height*2;break;case"vert_right":this.y=this.y+this.height*2;break;case"horz_slow":this.x=this.x+this.width*2;break;case"horz_medium":this.x=this.x+this.width*2;break;case"horz_fast":this.x=this.x+this.width*2}};var Player=function(a){this.game=a,this.context=a.context,this.player_x=230,this.player_y=390,this.player_width=27,this.player_height=33,this.sprite_x=2,this.sprite_y=3,this.sprite_width=27,this.sprite_height=33,this.slow=2,this.fast=7,this.last_move="",this.last_move_speed="",this.image=document.getElementById("characters_image")};Player.prototype.update=function(){var a=Helper.check_pixel_collision(this.context,this.player_x,this.player_y,this.player_width,this.player_height);a==="wall"&&this.backUp()},Player.prototype.draw=function(){Helper.drawRectangle(this.context,"rgba(0,0,0,0)",this.player_x,this.player_y,this.player_width,this.player_height),this.context.drawImage(this.image,this.sprite_x,this.sprite_y,this.sprite_width,this.sprite_height,this.player_x,this.player_y,this.player_width,this.player_height)},Player.prototype.backUp=function(){switch(this.last_move){case"left":this.moveRight(this.last_move_speed);break;case"right":this.moveLeft(this.last_move_speed);break;case"up":this.moveDown(this.last_move_speed);break;case"down":this.moveUp(this.last_move_speed)}},Player.prototype.moveLeft=function(a){typeof a=="undefined"&&(a="slow");var b=a==="slow"?this.slow:this.fast;this.player_x-=b,this.last_move="left",this.last_move_speed=a},Player.prototype.moveRight=function(a){typeof a=="undefined"&&(a="slow");var b=a==="slow"?this.slow:this.fast;this.player_x+=b,this.last_move="right",this.last_move_speed=a},Player.prototype.moveUp=function(a){typeof a=="undefined"&&(a="slow");var b=a==="slow"?this.slow:this.fast;this.player_y-=b,this.last_move="up",this.last_move_speed=a},Player.prototype.moveDown=function(a){typeof a=="undefined"&&(a="slow");var b=a==="slow"?this.slow:this.fast;this.player_y+=b,this.last_move="down",this.last_move_speed=a},Player.prototype.jump=function(){var a=this,b=this.game.fps,c=50,d=this.player_x+c,e=30,f=this.player_y-e,g=1e3,h;console.log(f),h=setInterval(function(){while(a.player_x<d)a.player_x+=c/b,a.player_y>f?a.player_y-=e/(b/2):a.player_y+=e/(b/2),console.log(a.player_y)},1e3/b)};var User=function(){this.name="Shane",this.level=1,this.q_attempted=0,this.q_correct=0,this.q_wrong=0};User.prototype.save={},User.prototype.load={};var Game=function(a,b,c,d){var e=this;this.user=c,this.mode=d,this.fps=30,this.context=b.getContext("2d"),this.context_width=b.width,this.context_height=b.height,this.player=new Player(this),this.awaiting_anwser=!1,this.current_question,this.hit_car=0,this.collision=!1,this.answered_questions=[],this.num_correct=0,this.num_wrong=0,this.board=new Main_Controller(this,this.player),this.gameloop,this.questionloop;var f=this;this.playing=!1,this.$el=a,this.bg=document.getElementById("town_image"),this.houses_visited=[],this.cars=this.buildCars(6),this.num_houses=5,this.in_house=!1,this.car_accident=!1,this.current_house=99};Game.prototype.buildCars=function(a){var b=["vert_left_north","vert_left_south","vert_right","horz_slow","horz_medium","horz_fast"],c=[];for(var d=0;d<a;d++)c[d]=new Car(this,b[d]);return c},Game.prototype.play=function(){var a=this;this.playing=!0,this.collision=!1,this.$el.trigger("play"),this.gameloop=setInterval(function(){a.updateAll(),a.drawAll()},1e3/a.fps)},Game.prototype.pause=function(){clearInterval(this.gameloop),this.playing=!1,this.$el.trigger("pause")},Game.prototype.updateAll=function(){this.num_correct===10&&this.victory(),this.num_wrong===10&&this.defeat(),this.player.update();for(var a=0;a<this.num_houses;a++){var b=Helper.check_collision(houses[a],this.player);b&&this.in_house===!1&&Helper.notIn(this.houses_visited,a)&&(this.pause(),this.houses_visited.push(a),this.in_house=!0,this.current_house=a,this.visitingHouse())}for(var c=0;c<this.cars.length;c++){this.cars[c].update();var d=Helper.check_collision(this.cars[c],this.player);d&&this.collision===!1&&(this.pause(),this.hitCar(c))}},Game.prototype.drawAll=function(){this.context.drawImage(this.bg,0,0,this.context_width,this.context_height),this.player.draw();for(var a=0;a<this.cars.length;a++)this.cars[a].draw()},Game.prototype.visitingHouse=function(){var a=this,b=this.current_house,c=houses[b].questions_correct;c===0&&this.$el.trigger("visit_house",houses[b]),c<3?(this.current_question=new Question(this,this.user.level,houses[b].number),this.promptQuestion()):(this.in_house=!1,this.awaiting_answer=!1,this.$el.trigger("leave_house",houses[b]),setTimeout(function(){a.play()},200))},Game.prototype.hitCar=function(a){this.collision=!0,this.hit_car=a,this.current_question=new Question(this,this.user.level),this.promptQuestion()},Game.prototype.promptQuestion=function(){this.awaiting_answer=!0,this.$el.trigger("question_prompted",this.current_question.question_string)},Game.prototype.checkAnswer=function(a){var b=this;this.current_question.answer===a?(this.num_correct++,this.$el.trigger("answer_correct"),this.collision?(this.cars[this.hit_car].moveAhead(),this.awaiting_answer=!1,this.collision=!1,setTimeout(function(){b.play()},200)):this.in_house&&(houses[this.current_house].questions_correct++,setTimeout(function(){b.visitingHouse()},500),this.awaiting_answer=!1)):(alert("nope - try again"),this.$el.trigger("question_prompted",this.current_question.question_string))},Game.prototype.victory=function(){this.pause(),this.$el.trigger("victory"),alert("You win! Nice work!")},Game.prototype.defeat=function(){this.pause(),this.$el.trigger("defeat")};var Main_Controller=function(a,b){var c=$("body"),d=$("#game"),e=$("#help_content"),f=d.find("canvas#board"),g=d.find("#single_question"),h=d.find("#house"),i=g.find("input"),j=d.find("#score");$timer=d.find("#timer"),timer,time=0,$("#play").on("click",function(){e.fadeOut(200),a.play()}),$("#stop").on("click",function(){a.pause()}),jwerty.key("arrow-up",function(a){a.preventDefault(),b.moveUp()}),jwerty.key("arrow-down",function(a){a.preventDefault(),b.moveDown()}),jwerty.key("arrow-left",function(a){a.preventDefault(),b.moveLeft()}),jwerty.key("arrow-right",function(a){a.preventDefault(),b.moveRight()}),jwerty.key("ctrl + arrow-up",function(a){a.preventDefault(),b.moveUp("fast")}),jwerty.key("ctrl + arrow-down",function(a){a.preventDefault(),b.moveDown("fast")}),jwerty.key("ctrl + arrow-left",function(a){a.preventDefault(),b.moveLeft("fast")}),jwerty.key("ctrl + arrow-right",function(a){a.preventDefault(),b.moveRight("fast")}),jwerty.key("p",function(b){b.preventDefault(),e.fadeOut(200),a.play()}),jwerty.key("s",function(b){b.preventDefault(),a.pause()}),jwerty.key("return",function(b){a.awaiting_answer&&(b.preventDefault(),a.checkAnswer(parseInt(i.val())))}),d.on("play",function(){f.css("opacity",1),timer=setInterval(function(){time++,$timer.text(time)},1e3)}),d.on("pause",function(){f.css("opacity",.5),clearInterval(timer)}),d.on("question_prompted",function(a,b){g.css("display","block"),i.focus(),g.prepend("<p>"+b+" =</p>")}),d.on("answer_correct",function(){j.append("<p>yay</p>"),setTimeout(function(){g.fadeOut(200),i.val(""),g.find("p").remove()},200)}),d.on("answer_wrong",function(){g.append("<p>Boo!</p>"),g.css("display","block")}),d.on("visit_house",function(a,b){h.fadeIn(200),h.append('<p class="intro">'+b.greeting+"</p>"),setTimeout(function(){h.append('<p class="intro">Here are your questions.</p>')},1e3),setTimeout(function(){h.append('<p class="intro">Ready...</p>')},2e3),setTimeout(function(){h.append('<p class="intro">Set...</p>')},3e3),setTimeout(function(){h.append('<p class="intro">Go...</p>')},4e3),setTimeout(function(){h.find(".intro").remove(),g.css("z-index",101)},5e3)}),d.on("leave_house",function(a,b){g.css("z-index",99),h.append('<p class="outro">'+b.goodbye+"</p>"),setTimeout(function(){h.find(".outro").remove(),h.fadeOut(300)},1e3)})};$(function(){function d(){$("#main_menu_content").prepend("<h1>Hi "+c.name+" !</h1>"),$("#main_menu").slideDown(),$("#game").fadeIn()}function e(a){var b=new Game($("#game"),document.getElementById("board"),c,a);$("#main_menu").fadeOut(),$(".game_controls").fadeIn(),b.play()}Array.prototype.remove=function(a,b){var c=this.slice((b||a)+1||this.length);return this.length=a<0?this.length+a:a,this.push.apply(this,c)};var a=localStorage.getItem("users"),b=a?JSON.parse(a):{},c;$("#login_form input").val("").focus(),$("body").on("click","#play_mult_mode",function(a){e("*")}),$("body").on("click","#play_add_mode",function(a){e("+")}),$("body").on("click","#login_form button",function(a){a.preventDefault();var e=$("#login_form input").val();b[e]?(c=b[e],$("#login").slideUp(function(){d()})):($("#join").slideDown(function(){$("#login").slideUp()}),$("#join_form input").val(e).focus())}),$("body").on("click","#join_form button",function(a){a.preventDefault();var e=$("#join_form input").val();b[e]?alert("sorry, name taken"):(b[e]={name:e,level:1},c=b[e],localStorage.setItem("users",JSON.stringify(b)),$("#join").slideUp(function(){d()}))}),$("body").on("click","#login a.join",function(a){a.preventDefault(),$("#join").slideDown(function(){$("#login").slideUp()}),$("#join_form input").val(name).focus()})});